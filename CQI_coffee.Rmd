---
title: "CQI_coffee"
subtitle: ""
author: "Jean Dos Santos"
date: "August 2020"
output:
  word_document:
    highlight: tango
    toc: yes
    toc_depth: 2
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    highlight: tango
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE, fig.align = "center")
```

# Import Packages

```{r}
if(!require(pacman, quietly = TRUE)){ install.packages("pacman", quiet = TRUE, verbose = FALSE) }
pacman::p_load(caret, tidyverse, magrittr, tidyselect, assertive, stringi, janitor, gdata, tools, renv, install = TRUE, update = FALSE)
```

```{r}
print_plots <- TRUE
save_plots <- TRUE
save_plots_dir <- "results/charts/"
custom_messages <- TRUE
```



***

# Import Data

```{r}
raw_arabica <- read_csv("data/arabica_ratings_raw.csv")
raw_robusta <- read_csv("data/robusta_ratings_raw.csv")
```


# Data Cleaning

```{r}
print_dimensions(raw_arabica, message = FALSE)
print_dimensions(raw_robusta, message = FALSE)
```

```{r}
print_colnames(raw_arabica)
print_colnames(raw_robusta)
```


```{r}
arabica <- rm_starts_with(raw_arabica) %>% janitor::remove_empty(which = "cols") 
robusta <- rm_starts_with(raw_robusta) %>% janitor::remove_empty(which = "cols") 

cols_in_ara <- setdiff(colnames(arabica), colnames(robusta))
cols_in_rob <- setdiff(colnames(robusta), colnames(arabica))
cols_in_both <- intersect(colnames(arabica), colnames(robusta))

print_intro("Columns in arabica only:\n", cols_in_ara, sep = " |")
print_intro("Columns in robusta only:\n", cols_in_rob, sep = " |")
print_intro("Columns in both tables:\n", cols_in_both, sep = " |")
```
```{r}
arabica <- clean_colnames(arabica) %>% janitor::remove_empty(which = "cols")
robusta <- clean_colnames(robusta) %>% janitor::remove_empty(which = "cols")
arabica$NOTES <- NULL

cols_in_ara <- setdiff(colnames(arabica), colnames(robusta))
cols_in_rob <- setdiff(colnames(robusta), colnames(arabica))
cols_in_both <- intersect(colnames(arabica), colnames(robusta))

print_intro("Columns in arabica only:\n", cols_in_ara, sep = " |")
print_intro("Columns in robusta only:\n", cols_in_rob, sep = " |")
print_intro("Columns in both tables:\n", cols_in_both, sep = " |")

robusta <-  gdata::rename.vars(robusta, 
                               from = c("FRAGRANCE_AROMA", "SALT_ACID", "BITTER_SWEET", "MOUTHFEEL", "UNIFORM_CUP"), 
                               to = c("AROMA", "ACIDITY", "SWEETNESS", "BODY", "UNIFORMITY"), info = TRUE)

merged_df <- merge(arabica, robusta, all=TRUE)
print_dimensions(merged_df)

# merged_df[merged_df$SPECIES == "Robusta", cols_in_ara]
# merged_df[merged_df$SPECIES == "Arabica", cols_in_rob]
```


```{r}
merged_dtypes <- sapply(merged_df, class)

print_intro("Numeric features:\n", names(merged_dtypes)[merged_dtypes == "numeric"])
print_intro("Non-numeric features:\n", names(merged_dtypes)[merged_dtypes != "numeric"])

# merged_df[, merged_dtypes == "numeric"]
# merged_df[, merged_dtypes == "character"]

```

***

## Process Countries of Origin

```{r}
print_intro("Countries of origin:\n", merged_df$COUNTRY_OF_ORIGIN %>% unique() %>% sort(), sep = " |")

print_intro(intro = "Entries with missing Country of origin:\n")
merged_df[is.na(merged_df$COUNTRY_OF_ORIGIN), c('OWNER', "PRODUCER", "CERTIFICATION_BODY", "CERTIFICATION_ADDRESS")]

# Assign entry with missing Country to Colombia

merged_df[is.na(merged_df$COUNTRY_OF_ORIGIN), "COUNTRY_OF_ORIGIN"] <- "Colombia"
```
```{r}
tot_mod <- 0

for (i in 1:nrow(merged_df)){
  
  country <- merged_df$COUNTRY_OF_ORIGIN[i]
  # print(country)
  
  country_clean <- country %>% 
    str_replace("Cote d\\?Ivoire", "Ivory Coast") %>% 
    str_replace(", United Republic Of", "") %>% 
    str_replace("United States", "USA")
  
  if (country_clean != country) { 
    
    merged_df$COUNTRY_OF_ORIGIN[i] <- country_clean
    cat("row", i, "Changed from:", country, "to:", country_clean, "\n")
    tot_mod <- tot_mod + 1
    
  }
}

print_intro("\nNumber of entries modified: ", tot_mod, eol = "\n", message = FALSE)

table(merged_df$COUNTRY_OF_ORIGIN) %>% sort(decreasing = TRUE) %>% data.frame()
```
***

## Process Region

```{r}
print_intro(intro = "First entries of `REGION`:\n", merged_df$REGION %>% head(20), sep = " |", message = FALSE)
print_intro(intro = "Last entries of `REGION`:\n", merged_df$REGION %>% tail(20), sep = " |", message = FALSE)

merged_df$REGION <- clean_text(merged_df$REGION)

print_intro(intro = "First entries of cleaned `REGION`:\n", merged_df$REGION %>% head(20), sep = " |", message = FALSE)
print_intro(intro = "Last entries of cleaned `REGION`:\n", merged_df$REGION %>% tail(20), sep = " |", message = FALSE)

# merged_df$REGION %>% table() %>% sort(decreasing = TRUE) %>% head(25)
```

## Process Harvest Year

```{r}
print_intro(intro = "Unique entries for `HARVEST_YEAR` before extraction:\n", merged_df$HARVEST_YEAR %>% unique() %>% sort(), sep = " |", message = FALSE)

merged_df$HARVEST_YEAR <- extract_year(merged_df$HARVEST_YEAR)

print_intro(intro = "Unique entries for `HARVEST_YEAR` after extraction:\n", merged_df$HARVEST_YEAR %>% unique() %>% sort(), sep = " |", message = FALSE)

merged_df$HARVEST_YEAR %>% summary()
print_total_NA(merged_df$HARVEST_YEAR)

if(print_plots){ merged_df$HARVEST_YEAR %>% hist(., main = "Distribution of Harvest Year", xlab = "Harvest Year", ) }
```
Most records are graded during the same year of the harvest year

Use Grading year to impute missing harvest year

```{r}
merged_df$GRADING_YEAR <- merged_df$GRADING_DATE %>% extract_year() 

print_intro("Average difference between grading year and harvest year: ", mean(merged_df$GRADING_YEAR[!is.na(merged_df$HARVEST_YEAR)] - merged_df$HARVEST_YEAR[!is.na(merged_df$HARVEST_YEAR)]) %>% round(4))

# impute missing harvest year with grading year
merged_df$HARVEST_YEAR[is.na(merged_df$HARVEST_YEAR)] <- merged_df$GRADING_YEAR[is.na(merged_df$HARVEST_YEAR)]

merged_df$HARVEST_YEAR %>% summary()
print_total_NA(merged_df$HARVEST_YEAR)
```

## Process altitude

























